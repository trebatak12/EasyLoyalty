0) GLOBAL CONSTRAINTS & SCOPE
Single tenant (one cafÃ©).

Amounts stored in cents; render integer CZK (e.g., 1â€¯430 CZK) in UI (no halÃ©Å™e in UI).

No expiration of balances; void (storno) window 120 s after a charge.

No split payments; refunds only in person, represented as manual adjustments.

Out of scope (PoC): POS integration; device API keys; multitenancy; referrals; notifications; payment compliance review.

JSON everywhere; neutral, safe errors.

Accessibility: WCAG AA, visible focus rings, 44Ã—44 px tap targets, keyboardâ€‘navigable.

Security: strong hashing, token rotation, session cookies for admin, rate limits, audit logs.

1) BRIEF / GOAL
Goal: Simple loyalty for one cafÃ©. Customers top up fixed CZK packages; the cafÃ© grants a oneâ€‘time bonus per topâ€‘up. Payment in cafÃ© via QR (with manual code fallback).

Admin â€œAccept paymentâ€ flow: Enter amount â†’ scan QR / enter code â†’ Charge â†’ show Success with Void (120 s).

PoC success metrics

Topâ€‘ups reliably credit balance + bonus.

QR payments + 120 s void work with idempotency.

Admin can view members, total liability, total bonuses, and accept payments quickly.

Customer Home shows Current balance and â€œCafe added to you in totalâ€ (lifetime bonuses).

2) BUSINESS RULES
Topâ€‘up packages (constants)

Package	Pay	Bonus	Wallet Credit	Effective bonus
MINI	390	+30	420	~7.7%
STANDARD	890	+90	980	~10.1%
MAXI	1590	+230	1820	~14.5%
ULTRA	2090	+400	2490	~19.1%

Bonus is granted once per topâ€‘up; accumulates lifetime as â€œCafe added to you in totalâ€; never decreases.

Balance does not expire; valid until fully spent.

No split payments: if balance < amount, deny charge (clear message).

Refunds in person only â†’ manual adjustments (+/â€‘).

Voids â‰¤120 s restore the full charged amount; lifetime bonus unchanged.

3) ROLES & AUTH
Customer: JWT access + refresh; owns exactly one wallet.

CafÃ© admin/staff: cookie session (HttpOnly, SameSite=Lax), can accept payments, view members/summaries, create manual adjustments.

Mode selection: â€œIâ€™m a customerâ€ vs â€œIâ€™m a cafÃ©â€.

Route guards: /admin/* requires admin session; customer pages require access token.

4) DATA MODEL (PostgreSQL; amounts in cents)
Tables (create exactly with these columns; use citext & pgcrypto):

users: id uuid PK, email citext UNIQUE, name text, password_hash text, status text DEFAULT 'active' (active|blocked), created_at ts, last_login_at ts.

wallets: id uuid PK, user_id uuid UNIQUE FKâ†’users, balance_cents int DEFAULT 0, bonus_granted_total_cents int DEFAULT 0, last_activity_at ts.

admin_users: id uuid PK, email citext UNIQUE, name text, password_hash text, role text DEFAULT 'manager' (manager|staff), status text DEFAULT 'active', created_at ts, last_login_at ts.

refresh_tokens: id uuid PK, user_id uuid FK, token_hash text, user_agent text, ip inet, created_at ts, expires_at ts, revoked_at ts.

admin_sessions: id uuid PK, admin_id uuid FK, created_at ts, expires_at ts, revoked_at ts, ip inet, user_agent text.

audit_logs: id uuid PK, actor_type text (user|admin|system), actor_id uuid, action text, meta jsonb, created_at ts.

metrics_daily (optional): date PK, members_count int, liability_cents int, bonus_granted_cents int, spend_cents int.

Ledger & idempotency (mustâ€‘have additions):

transactions (immutable ledger): see Â§ 8.A SQL.

idempotency_keys: see Â§ 8.B SQL.

Indexes: per FKs + unique constraints; indexes for tokens/sessions/audits; GIN on audit_logs.meta.

5) API â€” CUSTOMER (JWT)
POST /auth/signup { email, name, password } â†’ create user+wallet; set last_login_at; audit signup.
200 { user:{id,email,name}, accessToken, refreshToken }

POST /auth/login { email, password } â†’ rateâ€‘limit & lockout; set last_login_at; audit success/failure.
200 { user, accessToken, refreshToken }

POST /auth/refresh { refreshToken } â†’ validate (hash in DB), rotate (revoke old, issue new); audit token_refresh.
200 { accessToken, refreshToken }

POST /auth/logout { refreshToken } (or all) â†’ revoke refresh(es); audit logout.
204

GET /me (bearer) â†’ { id,email,name,status,lastLoginAt }

GET /me/wallet (bearer) â†’ { balanceCZK, bonusGrantedTotalCZK, lastActivity }

GET /me/history?type=all|topups|transactions&cursor= â†’ paginated list

POST /me/topup { packageCode } â†’ on success:

Create topâ€‘up transaction in ledger (+pay+bonus), update wallet.balance_cents and wallet.bonus_granted_total_cents += bonus atomically; update last_activity_at.

If gateway present, use webhook /payments/callback.
200 with updated wallet summary.

POST /me/qr â†’ { qrPayload, shortCode, expiresAt }

QR JWT with claims { sub:user_id, nonce, iat, exp<=60s }; manual code 8â€“10 alphanum + checksum; both bound to same TTL.

Antiâ€‘replay: mark token used on first successful /admin/charge/init.

6) API â€” ADMIN (SESSION)
POST /admin/login { email, password } â†’ create admin_sessions (idle 30m, abs 8h), set cookie admin_sid (HttpOnly, SameSite=Lax, Secure in prod); audit login.
204

POST /admin/logout â†’ revoke session & clear cookie; audit session_revoke.
204

GET /admin/me â†’ { id,email,name,role,status,lastLoginAt }

POST /admin/charge/init { tokenOrCode } â†’ validate QR/Code (not expired or used); antiâ€‘replay guard;
200 { userId, customerName, balanceCZK, chargeId }

POST /admin/charge/confirm { chargeId, amountCZK, idempotencyKey } â†’ DB tx:

Ensure idempotency; ensure sufficient funds; insert ledger transaction (-amount); update wallet cache.
200 { newBalanceCZK }

POST /admin/charge/void { chargeId } â†’ if succeeded and <=120 s: insert ledger transaction (+amount), restore wallet; mark charge voided; audit.
200

GET /admin/customers?query=&cursor= â†’ list { name,email,balanceCZK,bonusGrantedTotalCZK,lastActivity }

GET /admin/summary â†’ { membersCount, liabilityCZK, bonusGrantedTotalCZK, spendTodayCZK, spendWeekCZK }

POST /admin/adjustment { userId, amountCZK (+/â€‘), reason, idempotencyKey } â†’ insert ledger transaction (Â±amount, meta.reason); update wallet.
200 { newBalanceCZK }

GET /admin/customers/export.csv (rateâ€‘limit 1/min) â†’ CSV; filters: search, minBalance, maxBalance.

7) STATE MACHINES & INTEGRITY
Charge: pending â†’ succeeded â†’ (â‰¤120 s) voided.
Topâ€‘up: initiated â†’ succeeded | failed.
QR token: issued (â‰¤60 s) â†’ used OR expired.

All money movements write to transactions ledger; wallet cache updated in same DB tx.

Lifetime bonus only increases on topâ€‘ups; never reduced by charges/voids/adjustments.

8) MUSTâ€‘HAVE APPENDICES (copy into implementation)
A) SQL â€” Ledger (immutable)
sql
ZkopÃ­rovat
Upravit
CREATE TYPE txn_type AS ENUM ('topup','charge','void','adjustment');

CREATE TABLE IF NOT EXISTS transactions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  type txn_type NOT NULL,
  amount_cents integer NOT NULL, -- + credit, - debit
  related_id uuid NULL,          -- e.g. charge_id or topup_id
  idempotency_key text NULL,
  created_by text NOT NULL,      -- 'user' | 'admin' | 'system'
  meta jsonb NOT NULL DEFAULT '{}',
  created_at timestamptz NOT NULL DEFAULT now()
);
CREATE UNIQUE INDEX IF NOT EXISTS idx_txn_idem ON transactions(idempotency_key) WHERE idempotency_key IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_txn_user_time ON transactions(user_id, created_at DESC);
B) SQL â€” Idempotency keys
sql
ZkopÃ­rovat
Upravit
CREATE TABLE IF NOT EXISTS idempotency_keys (
  key text PRIMARY KEY,
  first_seen_at timestamptz NOT NULL DEFAULT now(),
  request_hash text NOT NULL
);
C) API adaptations (enforce)
/me/topup â†’ ledger +pay+bonus, update wallet cache & bonus_granted_total, single DB tx.

/admin/charge/confirm â†’ require idempotencyKey, ledger -amount, update wallet cache, tx.

/admin/charge/void â†’ â‰¤120 s, ledger +amount, update wallet cache, tx.

/admin/adjustment â†’ require reason, ledger Â±amount (meta.reason), update wallet cache, tx.

9) SECURITY & PRIVACY
Passwords: bcrypt cost 12 (or argon2id). Optional pepper AUTH_PEPPER.

JWT (customers): HS256, secret JWT_ACCESS_SECRET; access TTL 15 min. Refresh: opaque 256â€‘bit; store SHAâ€‘256 hash; TTL 30 days; rotate on refresh.

Admin sessions: cookie admin_sid, random 256â€‘bit; HttpOnly, Secure (prod), SameSite=Lax, path /. Idle 30 min, absolute 8 h, sliding window.

Rateâ€‘limit & lockout: 5 attempts/5 min/IP + 10 attempts/15 min/email â†’ 15â€‘min lockout.

CORS: allow app origin only; credentials for admin routes.

CSRF (admin): rely on sameâ€‘site cookie + validate Origin/Referer on stateâ€‘changing endpoints.

Headers: CSP (defaultâ€‘src 'self'), HSTS (prod), Xâ€‘Contentâ€‘Typeâ€‘Options, Xâ€‘Frameâ€‘Options deny, Referrerâ€‘Policy strictâ€‘origin.

Logging: never log plaintext secrets; mask PII.

Blocked accounts: status='blocked' â†’ 403 on auth attempts + audit.

Security extras (recommended): password reset (ttl 30m), email verification (optional), soft CAPTCHA after X failures, optional admin IP allowlist.

10) ERROR MODEL
HTTP codes:
400 validation Â· 401 unauthenticated Â· 403 forbidden/blocked Â· 404 not found/expired token
409 idempotency conflict Â· 410 expired token Â· 422 insufficient funds Â· 429 rateâ€‘limited Â· 500 server error

Canonical codes (example):

json
ZkopÃ­rovat
Upravit
{
  "E_INPUT": 400,
  "E_AUTH": 401,
  "E_FORBIDDEN": 403,
  "E_NOT_FOUND": 404,
  "E_IDEMPOTENCY_CONFLICT": 409,
  "E_EXPIRED_TOKEN": 410,
  "E_INSUFFICIENT_FUNDS": 422,
  "E_RATE_LIMIT": 429
}
Error payload:

json
ZkopÃ­rovat
Upravit
{ "error":"BadRequest", "message":"Invalid input", "code":"E_INPUT", "details":{...} }
11) ENV & CONFIG (examples)
ini
ZkopÃ­rovat
Upravit
DATABASE_URL=postgres://user:pass@localhost:5432/easyloyalty
JWT_ACCESS_SECRET=change_me_access
AUTH_PEPPER=optional_pepper_value
SESSION_COOKIE_NAME=admin_sid
NODE_ENV=development
APP_ORIGIN=http://localhost:5173
12) MIGRATIONS & SEED (must implement)
Files

pgsql
ZkopÃ­rovat
Upravit
migrations/
  01_init_extensions.sql
  02_schema.sql
  03_indexes.sql
scripts/
  seed-demo.ts
migrations/01_init_extensions.sql

sql
ZkopÃ­rovat
Upravit
CREATE EXTENSION IF NOT EXISTS citext;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
migrations/02_schema.sql
Create all tables from Â§Â§ 4 & 8 (users, wallets, admin_users, refresh_tokens, admin_sessions, audit_logs, metrics_daily, transactions, idempotency_keys).

migrations/03_indexes.sql
Create all indexes listed in Â§Â§ 4 & 8.

Seed script scripts/seed-demo.ts (TypeScript, idempotent; bcrypt cost 12):

Demo Customer â€” demo.customer@easyloyalty.dev / Demo1234! (wallet 0/0).

Demo CafÃ© (admin) â€” demo.cafe@easyloyalty.dev / DemoAdmin1234! (role manager).

Block seed in production unless ALLOW_PROD_SEED=1.

Print credentials on completion.

package.json scripts

json
ZkopÃ­rovat
Upravit
{
  "scripts": {
    "migrate": "psql \"$DATABASE_URL\" -f migrations/01_init_extensions.sql && psql \"$DATABASE_URL\" -f migrations/02_schema.sql && psql \"$DATABASE_URL\" -f migrations/03_indexes.sql",
    "seed:demo": "ts-node scripts/seed-demo.ts"
  }
}
Acceptance (migrations+seed):

npm run migrate is idempotent and creates all tables+indexes.

npm run seed:demo creates or upserts exactly two demo accounts; no duplicates.

Passwords are hashed; seed blocked in prod by default.

README documents migrate/seed usage.

13) OPENAPI + RUNTIME VALIDATION (must implement)
Add openapi.yaml (OAS 3.1) covering all endpoints; serve Swagger UI at /docs.

Generate TypeScript types for client and server (e.g., openapi-typescript).

Add Zod/Valibot schemas mirroring OAS; validate request body/params and (in dev) assert response conformance.

14) HEALTH / READY / VERSION (must implement)
GET /health â†’ 200 { ok:true } (liveness).

GET /ready â†’ 200/503 { db:"ok|down" } (DB ping).

GET /version â†’ { commit:"<git_sha>", builtAt:"ISO8601" }.

On each request: if X-Request-ID missing â†’ generate UUID; echo back and log.

Add response headers: X-Request-ID, X-Version.

15) BACKUPS & RUNBOOK (document in README)
Nightly DB dump; retention 7â€“14 days; monthly restore test.

CI: run migrations against a fresh DB as a dryâ€‘run safeguard.

Runbook: rotate JWT_ACCESS_SECRET, block an account, revoke all refresh tokens, invalidate admin sessions.

16) FRONTEND ARCHITECTURE (React + Tailwind + React Router + React Query)
Structure (keep current if present):

pgsql
ZkopÃ­rovat
Upravit
src/
  app/              # routing/providers (AuthProvider, QueryClientProvider)
  components/       # UI primitives & composites (Card, Button, Input, QRPanel, Stepper, Toast)
  pages/            # ModeSelection, CustomerAuth, Home, TopUp, QR, History, AdminAuth, Accept, Members, Summaries
  hooks/            # useAuth, useAdminSession, useWalletQuery, useTopups, useMembers, useSummaries
  services/         # api clients: customer.ts, admin.ts (fetch wrapper with interceptors)
  styles/           # tokens.css, globals.css, tailwind.css
  utils/            # currency, time, idempotency, validators
  types/            # DTOs and response types
State: React Query for server state; Context for auth/session; local state for UI.

HTTP: attach Bearer token for customer; credentials:'include' for admin session.

Errors: central interceptors â†’ toasts; handle 401/419 (logout), 429 (retry message).

Formatting: integers with thin/nbsp spacing: 1â€¯430 CZK.

17) ROUTING MAP
Public

/ â†’ ModeSelection

/auth/customer â†’ CustomerAuth (Sign in / Sign up)

/admin/login â†’ AdminAuth

Customer (JWT)

/home â†’ CustomerHome

/topup â†’ TopUpPackages

/qr â†’ CustomerQR

/history â†’ History (Topâ€‘ups / Payments)

/settings (optional)

Admin (session)

/admin â†’ redirect to /admin/accept

/admin/accept â†’ AcceptPaymentWizard

/admin/members â†’ MembersList

/admin/summaries â†’ SummariesDashboard

/admin/settings (optional)

Route guards: unauth â†’ redirect; preserve redirectTo for postâ€‘login return.

18) VISUAL SYSTEM â€” Appleâ€‘style Beige (light first)
Design principles: clarity, deference, depth (soft shadows, translucent bars), consistency, touch+keyboard, gentle motion (150â€“220 ms).

Tokens (CSS) â€” paste into styles/tokens.css

css
ZkopÃ­rovat
Upravit
:root{
  --bg:#FAF7F2; --surface:#FFFFFF; --card:#F7F2EA; --border:#E7DFD2;
  --text:#2B261F; --muted:#6B6157;

  --primary:#7A4E2D; --primary-hover:#6E4527; --on-primary:#FFFFFF;
  --sage:#8E9B7A; --dusty:#7C8CA3; --ring:#D4A373;

  --success:#4F8A57; --warning:#C98A2B; --danger:#B64B3A; --info:#7C8CA3;

  --shadow-soft:0 8px 24px rgba(0,0,0,.08);
  --radius-lg:16px; --radius-md:12px; --radius-sm:10px;
}
html,body{
  background:var(--bg); color:var(--text);
  font-family:"SF Pro Text",-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
}
.header-blur{
  background:rgba(255,255,255,.72);
  backdrop-filter:saturate(180%) blur(20px);
  -webkit-backdrop-filter:saturate(180%) blur(20px);
  border-bottom:1px solid var(--border);
}
Tailwind mapping

ts
ZkopÃ­rovat
Upravit
extend:{
  colors:{
    bg:"var(--bg)", surface:"var(--surface)", card:"var(--card)", border:"var(--border)",
    text:"var(--text)", muted:"var(--muted)",
    primary:{ DEFAULT:"var(--primary)", hover:"var(--primary-hover)", foreground:"var(--on-primary)" },
    sage:"var(--sage)", dusty:"var(--dusty)", ring:"var(--ring)",
    success:"var(--success)", warning:"var(--warning)", danger:"var(--danger)", info:"var(--info)"
  },
  boxShadow:{ soft:"var(--shadow-soft)" },
  borderRadius:{ lg:"var(--radius-lg)", md:"var(--radius-md)", sm:"var(--radius-sm)" }
}
Recipe classes

Card: bg-card border border-border rounded-lg shadow-soft p-5

PrimaryButton: h-11 px-5 rounded-md bg-primary text-primary-foreground hover:bg-primary-hover focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:opacity-50

SecondaryButton: h-11 px-5 rounded-md bg-surface border border-border text-text hover:bg-white/70 focus-visible:ring-2 focus-visible:ring-ring

Input: h-11 w-full rounded-md bg-surface border border-border px-3 placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent

Divider: <hr class="border-t border-border">

QRPanel: card + centered QR (240â€“320px) + manual code badge + 60 s countdown ring.

Redlines / measurements

Grid 8â€‘px; page padding 24 (mobile) / 48 (desktop).

Cards radius 16, padding 20, gap 12â€“16.

Buttons height 44, radius 12, minâ€‘width 120.

Inputs height 44; labels 14/20; helpers 12/18.

Icons 20â€“24 px.

QR 240Ã—240 (mobile) / 320Ã—320 (tablet+); quiet zone 16 px.

Void timer ring 24 px (accent --ring).

Do & Donâ€™t

Do: generous spacing; restrained accents; visible focus; large readable currency.

Donâ€™t: multiple primary accents per screen; semiâ€‘transparent text for key info; harsh shadows; show halÃ©Å™e in UI.

Dark Latte (optional future)

css
ZkopÃ­rovat
Upravit
@media (prefers-color-scheme: dark){
  :root{
    --bg:#1C1917; --surface:#24211E; --card:#2A2623; --border:#3A332C;
    --text:#F5F0EA; --muted:#B8AFA5;
    --primary:#D4A373; --primary-hover:#C8935F; --on-primary:#2B261F;
    --sage:#A5B091; --dusty:#9AA8BE; --ring:#E4C39A;
    --shadow-soft:0 12px 28px rgba(0,0,0,.45);
  }
}
19) FRONTEND SCREENS â€” SPEC & BEHAVIOR
ModeSelection (Public)

Two fullâ€‘click cards: Customer â†’ /auth/customer; CafÃ© â†’ /admin/login.

A11y: tabbable, visible focus, whole card clickable.

CustomerAuth (Public)

Tabs: Sign in / Sign up; live password hints.

On success: store tokens; goto /home. Errors: 401/429 handled with toasts.

CustomerHome (JWT)

Cards: Current balance; Cafe added to you in total (lifetime bonus).

Actions: Top up, QR, History.

Data from /me/wallet; skeletons on load; optimistic postâ€‘topâ€‘up.

TopUpPackages (JWT)

Show 4 packages (Pay â†’ Total credited and Bonus).

Confirm; call /me/topup; success toast; update wallet & bonus.

CustomerQR (JWT)

Big QR + manual code + 60 s countdown; regenerate on expiry.

Call /me/qr on mount; reâ€‘issue when expired.

History (JWT)

Tabs: Topâ€‘ups / Payments; show date, amount, bonus (topâ€‘ups), status (âœ“/voided).

Cursor pagination; empty state with CTA.

AdminAuth (Public)

Email/password â†’ /admin/login; cookie set; goto /admin/accept.

AcceptPaymentWizard (Session)

Step 1: amount input + quick picks 85/120/178/250 (confirm if > 500 CZK).

Step 2: camera scan or manual code; after resolve show customer name, current balance, amount; Charge.

Step 3: success with Void 120 s (countdown). Edge cases: insufficient funds, expired QR.

MembersList (Session)

Columns: Name/Email | Balance | Added total | Last activity | Action

Search with debounce; row action Adjust balance â†’ modal.

CustomerAdjustmentModal (Session)

Fields: +/- amount; required reason (presets + free text).

On submit: /admin/adjustment; update row; audit entry.

SummariesDashboard (Session)

Cards: Members | Liability (sum balances) | Total bonuses | Today/Week spend.

Optional autoâ€‘refresh 60 s.

20) CAMERA & PERMISSIONS (Admin Scan)
Request camera; fallback prominently to manual code if denied.

Use facingMode:'environment' when available; handle portrait/landscape.

Debounce/manual code validation; rateâ€‘limit retries.

Show guidance frame; keep UI responsive.

21) ACCESSIBILITY & I18N
Keyboard reachable; visible focus rings; tap targets â‰¥ 44Ã—44.

Contrast AA: --text on --bg/--surface/--card; white on --primary.

Respect prefers-reduced-motion.

Centralize strings for easy EN/CZ switching later.

22) WIREFRAMES (ASCII)
Mode selection

less
ZkopÃ­rovat
Upravit
[logo] EasyLoyalty                                      [EN/CZ]

Welcome! Choose how you want to continue:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜• Iâ€™m a customer         â”‚    â”‚ ğŸª Iâ€™m a cafÃ©            â”‚
â”‚ Sign in / Sign up        â”‚    â”‚ Staff login              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Privacy] Â· [Terms] Â· [Support]
Customer Home

css
ZkopÃ­rovat
Upravit
Welcome back, Peter!                                          [â‹®]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Current balance                         â”‚
â”‚               1,430 CZK                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cafe added to you in total (i)          â”‚
â”‚                 550 CZK                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[ Top up ]   [ QR ]   [ History ]
Admin â€” Accept payment (1/3)

vbnet
ZkopÃ­rovat
Upravit
Amount: [  178  CZK ]   Quick picks: [85] [120] [178] [250]
[ Continue â†’ ]
Admin â€” Scan (2/3)

less
ZkopÃ­rovat
Upravit
[ camera preview ]   Fallback: Manual code [ J9F2-K7QP-X3 ] [ Verify ]

Found: Peter C.  | Balance: 1,430 CZK | Amount: 178 CZK
[ Charge ]
Admin â€” Confirmation + Void (3/3)

pgsql
ZkopÃ­rovat
Upravit
âœ… Charged: 178 CZK      New balance: 1,252 CZK

[ âŸ² Void ]  120 s (countdown)        [ New payment ]
23) PWA MINIMUM (Recommended)
public/manifest.webmanifest

json
ZkopÃ­rovat
Upravit
{
  "name": "EasyLoyalty",
  "short_name": "EasyLoyalty",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#FAF7F2",
  "theme_color": "#7A4E2D",
  "icons": [
    { "src": "/icons/icon-192.png", "sizes": "192x192", "type": "image/png" },
    { "src": "/icons/icon-512.png", "sizes": "512x512", "type": "image/png" }
  ]
}
Add appleâ€‘touch icon(s); no offline yet.

24) CSV EXPORT (Admin)
Endpoint: GET /admin/customers/export.csv

Query params: search, minBalance, maxBalance

Rateâ€‘limit: 1/min

Format:

css
ZkopÃ­rovat
Upravit
email,name,balance_czk,bonus_total_czk,last_activity
john@example.com,John Doe,1430,550,2025-07-15T09:12:33Z
25) OBSERVABILITY & PERFORMANCE
Sentry (FE+BE) with error & performance tracing.

Structured JSON logs; no PII.

Performance budgets: JS < 200 kB (gzip) on first load; lazyâ€‘load admin area.

Lighthouse (mobile) target: >90 for Performance & PWA.

26) TEST PLAN
API tests

Signup â†’ creates user+wallet â†’ /me OK.

Wrong password â†’ 401; repeated â†’ 429/lockout.

Refresh rotates tokens; old refresh denied.

Logout revokes refresh; subsequent refresh fails.

Admin login sets cookie; /admin/me OK; idle >30m â†’ 401.

Topâ€‘up 890 â†’ balance +980, lifetime bonus +90; history shows entry.

Charge 178 â†’ balance -178; Void â‰¤120 s â†’ balance restored; transaction voided.

Insufficient balance â†’ 422; no deduction.

Expired QR â†’ init returns 404/410 style.

Adjustment Â± with reason â†’ balance updated; audit recorded.

E2E UI tests

Customer: sign up/in â†’ topâ€‘up â†’ QR â†’ history.

Admin: login â†’ accept payment â†’ void â†’ members & summaries.

Guards: /admin w/o cookie â†’ /admin/login; /home w/o JWT â†’ /auth/customer.

A11y & visual regression (Recommended)

@axe-core checks on key screens (no critical violations).

Visual snapshots for ModeSelection, Customer Home, Accept Payment.

27) BUILD, RUN, CI/CD
Backend: env, migrations, start script; health endpoints.

Frontend: vite/webpack build; .env for VITE_API_BASE.

CI pipeline:

Lint & typecheck (ESLint, tsc)

npm run migrate (fresh DB), npm run seed:demo (where applicable)

API & E2E tests

Build artifacts (api/web)

Docker compose (suggested): api, web, db (Postgres), nginx TLS; run migrations & (dev) seed on first boot.

28) DELIVERABLES
Backend: migrations; endpoints; security (hashing/JWT/cookie); rateâ€‘limit; audit logs; ledger + idempotency; OpenAPI + Swagger UI; health/ready/version; seed demo accounts; README (env, migrate, seed, run, runbook).

Frontend: routes, guards, screens; Appleâ€‘style beige tokens & classes; QR screen with timer/code; Accept Payment wizard; Members & Summaries; PWA manifest; CSV export; screenshots/GIF (Mode selection, Customer Home, Accept Payment).

Postman/Insomnia collection or curl scripts for core flows.

Sentry configured (DSN via env), structured logs.

Performance budget enforced.

Commit messages (examples)

feat(auth): implement customer JWT + admin sessions

feat(seed): add demo customer and cafe admin

feat(ui): apple-style beige tokens & component recipes

feat(frontend): routes, guards, QR screen, accept-payment wizard

feat(api): ledger + idempotency + summaries

feat(docs): openapi.yaml + Swagger UI

feat(ops): health/ready/version + request id headers

29) ACCEPTANCE (PoC â€œDoneâ€)
All success metrics (Â§1) met.

All API & E2E tests (Â§26) pass.

Migrations & seed work idempotently; demo accounts usable.

Visual QA passes (contrast, focus rings, spacing, QR sizes, void countdown).

README updated with setup, credentials, and limitations.